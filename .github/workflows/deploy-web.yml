name: "deploy-web"

on:
  pull_request:
    branches: ["main"]
  # push:
  #   branches: ["main"]
    # tags: [v*]
  # TODO: remove, only for testing

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: wasm32-unknown-unknown

      - name: "Build campfire"
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --package campfire

      - name: "Build web client"
        uses: actions-rs/cargo@v1
        with:
          command: run
          args: --package campfire -- web build --profile release --target standalone

      - name: Upload package
        uses: actions/upload-artifact@v3
        with:
          name: ambient-web-standalone
          path: ./web/pkg

  upload:
    - id: auth
      name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v0
      with:
        token_format: access_token
        workload_identity_provider: projects/549180905870/locations/global/workloadIdentityPools/github-pool/providers/github-provider
        service_account: github@ambient-733e7.iam.gserviceaccount.com
        access_token_lifetime: 1800s
